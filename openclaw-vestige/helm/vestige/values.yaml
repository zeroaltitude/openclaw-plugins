# Default values for vestige

replicaCount: 1

# ── Container images ──────────────────────────────────────────────────────────
# Two separate images: vestige-mcp (Rust + supergateway) and bridge (Python).

vestigeImage:
  repository: ""  # e.g. 123456789.dkr.ecr.us-west-2.amazonaws.com/vestige-mcp
  tag: "latest"
  pullPolicy: IfNotPresent

bridgeImage:
  repository: ""  # e.g. 123456789.dkr.ecr.us-west-2.amazonaws.com/vestige-bridge
  tag: "latest"
  pullPolicy: IfNotPresent

# Legacy single-image config (ignored by new deployment template)
image:
  repository: ""
  tag: "latest"
  pullPolicy: IfNotPresent

imagePullSecrets: []

service:
  type: ClusterIP
  port: 8000

ingress:
  enabled: true
  className: alb
  # Optional: ARN of the ACM certificate for ALB HTTPS termination
  certificateArn: ""
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internal
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    alb.ingress.kubernetes.io/healthcheck-path: /health
  hosts:
    - host: vestige.internal
      paths:
        - path: /
          pathType: Prefix

# ── Resources ─────────────────────────────────────────────────────────────────
# Separate resource blocks for each container in the pod.

vestigeResources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

bridgeResources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 250m
    memory: 256Mi

# Legacy single-container resources (ignored by new deployment template)
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

persistence:
  enabled: true
  storageClass: gp3
  accessModes:
    - ReadWriteOnce
  size: 5Gi
  mountPath: /data

env:
  LOG_LEVEL: info

# Auth token — REQUIRED for production deployments.
# Either set auth.token via --set or provide auth.existingSecret.
# Leaving both empty will cause the secret template to fail at deploy time.
# For local dev without auth, set env var VESTIGE_ALLOW_ANONYMOUS=true.
auth:
  existingSecret: ""   # Use an existing k8s secret name
  secretKey: token     # Key within the secret
  token: ""            # Inline token (not recommended for prod)

# ── Probes ────────────────────────────────────────────────────────────────────
# Separate probe blocks for each container.

probes:
  vestige:
    # Startup probe: gives up to 5 minutes for initial model download
    startup:
      exec:
        command:
          - curl
          - -sf
          - http://localhost:3100/mcp
          - -X
          - POST
          - -H
          - "Content-Type: application/json"
          - -d
          - '{"jsonrpc":"2.0","id":0,"method":"tools/list","params":{}}'
      failureThreshold: 30
      periodSeconds: 10
    liveness:
      exec:
        command:
          - curl
          - -sf
          - http://localhost:3100/mcp
          - -X
          - POST
          - -H
          - "Content-Type: application/json"
          - -d
          - '{"jsonrpc":"2.0","id":0,"method":"tools/list","params":{}}'
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      exec:
        command:
          - curl
          - -sf
          - http://localhost:3100/mcp
          - -X
          - POST
          - -H
          - "Content-Type: application/json"
          - -d
          - '{"jsonrpc":"2.0","id":0,"method":"tools/list","params":{}}'
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  bridge:
    startup:
      httpGet:
        path: /health
        port: http
      failureThreshold: 12
      periodSeconds: 5
    liveness:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      httpGet:
        path: /readyz
        port: http
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

nodeSelector: {}
tolerations: []
affinity: {}
